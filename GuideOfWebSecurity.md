#                              网络安全自救指南

## 信息安全保障

### pdrr安全模型

* 保护(Protection)
* 检测(Detection)
* 响应(Reaction)
* 回复(Restore)

### 攻击类型

* 阻断：切断线路
* 截取：未授权访问
* 篡改：访问并修改
* 伪造：伪造信息
* 主动攻击：检测，从破坏中恢复
  * 伪装
    * 一个实体假装成另一个实体，获取额外特权
  * 回答
    * 被动捕获再重传
  * 修改报文
    * 合法报文某些部分被修改
  * 拒绝服务
    * 阻止通信设施的正常使用
* 被动攻击：获取信息，强调阻止而不是检测
  * 报文内容泄露
  * 通信分析
* 访问攻击：获取非授权信息，针对机密性
  * 窥探：查看信息文件
  * 窃听：窃听信息通过的地方
  * 截获：在信息到达目的地前拦截
* 篡改攻击：修改未授权攻击，针对完整性
  * 改变
  * 插入
  * 删除
* 拒绝服务攻击：拒绝合法用户使用系统，针对可用性
  * 拒绝访问信息：破坏信息
  * 拒绝访问应用：破坏应用
  * 拒绝访问系统：系统宕机
  * 拒绝访问通信：切断电缆
* 否认攻击：否认企图给出假的信息，针对可审性
  * 假冒：假冒别人和别人的系统
  * 否认：抵赖曾经登录和处理的事件

## 网络信息安全服务

|              | 机密性 | 完整性 | 可用性 | 可审性 |
| :----------: | :----: | :----: | :----: | :----: |
| **访问攻击** |   x    |        |        |   x    |
| **篡改攻击** |        |   x    |        |   x    |
| **拒绝服务** |        |        |   x    |        |
|   **否认**   |        |   x    |        |   x    |



#### 机密性服务：提供信息的保密

* 文件机密性
  * 身份标识和身份鉴别
  * 密钥管理
* 信息传输机密性
  * 报文信息加密
  * 身份标识和身份鉴别
* 通信流机密性
  * 端到端
  * 遮掩信息流

#### 完整性服务：提供信息的正确性

* 文件完整性
  * 未授权访问
* 信息传输完整性
  * 篡改和否认攻击

#### 可用性服务：提供的信息可用

* 后备
* 在线恢复
* 灾难恢复

#### 可审性服务：不针对攻击提供保护，与其他服务结合

* 身份标识和身份鉴别
  * 目的：对试图执行功能的人的身份进行标识，验证这些人声称的身份

## 恶意代码

病毒：**计算机程序中插入的破坏计算机功能或数据**，影响计算机使用并能**自我复制**的一组计算机指令或代码

木马：在用户不了解的情况下拷贝文件或窃取密码

蠕虫：可以从一台主机移动到另一台主机，可以自我复制，可以独立运行

病毒、蠕虫和木马的比较

|     特性     |      病毒      |      蠕虫      |        木马        |
| :----------: | :------------: | :------------: | :----------------: |
|    传染性    |       强       |      很少      |        很少        |
|   传播能力   |       强       |      极强      |        一般        |
|   感染对象   |      文件      |      进程      |        进程        |
| 主要传播方式 |      文件      |      网络      |        网络        |
|    破坏性    |       强       |       强       |        很少        |
|    隐蔽性    |       强       |       强       |        极强        |
|    顽固性    |      较强      |      较强      |        极强        |
|    欺骗性    |      一般      |      一般      |         强         |
| 主要攻击目的 | 破坏数据和信息 | 耗尽计算机资源 | 窃取信息、提供后门 |

### CreateRemoteThread()函数注入

远程注入dll流程

1. 提升自身进程权限为SeDebugPrivilege
2. OpenProcess()获取目标进程的句柄
3. VirtualAllocEx()在目标进程中分配一块内存
4. WriteProcessMemeory()将要注入的dll路径写入3分配的内存
5. GetProcAddress()获得LoadLibraryA()函数的地址
6. CreateRemoteThread()创建远程线程，线程起始地址设置为LoadLibraryA()函数的地址，线程的参数设置为4中dll路径在目标进程中的路径
7. 等待远程线程结束后退出

## ARP攻击

### ARP协议

  主机设有一个ARP高速缓存，存放局域网中主机的IP地址和MAC地址对。当两台主机进行通信时，通过查询ARP缓存表来进行IP地址到MAC地址的转换。缓存表中不存在查找项时，运行ARP广播查找目标主机的MAC地址

### ARP欺骗

  ARP欺骗利用修改主机ARP缓存表的方法达到嗅探的目的，是一种中间人攻击。主机C为了达到嗅探的目的，会向主机A和主机B分别发送ARP应答包，告诉它们IP地址为IPB的主机MAC地址为MACC，IP地址为IPA的主机MAC地址为MACC

## 拒绝服务攻击

### Ping of Death

* 只有64kb缓冲区存放数据包
* 攻击者附加冗余信息，使其超过上限
* 引起系统内存分配错误，导致TCP/IP堆栈溢出，系统崩溃，挂起或重启

### Teardrop

* MTU限制包的大小，大数据包需要分段
* 向目标机器发送损坏的IP包，攻击通过TCP/IP协议栈中分片重组代码中的bug瘫痪各种操作系统
* Teardrop攻击出线数据包超大，溢出(假设数据包中第二片IP包的偏移量小于第一片结束的位移，而且算上第二片IP包的Data，也未超过第一片的尾部，这就是重叠现象）

### Land

* 用一个特别打造的SYN包，它的源地址和目标地址都被设置成某一个服务器地址
* 此举将导致接受服务器向它自己的地址发送SYN一ACK消息，结果这个地址又发回ACK消息并创建一个空连接
* 被攻击的服务器每接收一个这样的连接都将保留，直到超时

### SYN Flood

原理：

* 每个机器都需要为半开连接分配一定的资源
* 这种半开连接的数量是有限制
* 共计方利用 TCP 连接三次握手过程，打开大量的半开 TCP
* 目标机器不能进一步接受 TCP 连接。机器就不再接受进来的连接请求

攻击细节：

* 连接请求是正常的，但是，源 IP 地址往往是伪造的，并且是一台不可达的机器的 IP 地址，否则，被伪造地址的机器会重置这些半开连接
* 一般，半开连接超时之后，会自动被清除，所以，攻击者的系统发出 SYN包的速度要比目标机器清除半开连接的速度要快
* 任何连接到 Internet 上并提供基于 TCP 的网络服务，都有可能成为攻击的目标
* 这样的攻击很难跟踪，因为源地址往往不可信，而且不在线

### Smurf

原理：

* 攻击者向一个广播地址发送 ICMP Echo 请求，并且用受害者的IP 地址作为源地址
* 广播地址网络上的每台机器响应这些 Echo 请求，同时向受害者主机发送 ICMP Echo- - Reply
* 受害者主机会被这些大量的应答包淹没

### HTTP Flood

* HTTP GET FLOOD是针对应用服务器上的某个文件，对其进行快速的反复的重复读取操作，从而造成服务器的资源减少直至崩溃
* HTTP GET FLOOD针对的不仅仅是WEB服务器，还有数据库服务器。大量的HTTP请求产生了大量的数据库查询，可以在几秒之内使数据库停止响应，系统负载升高，最终导致服务器宕机

## DNS安全

### 递归查询

未能在本地查询相应的信息，就向其他服务器进行查询，代替用户扮演解析器的角色

### 迭代查询

返回本地信息或者返回可能存在信息的dns服务器地址

### DNS应答包被接受条件

* 应答包question域和请求包question域的域名信息一致
* 应答包的Transaction ID和请求包中的Transaction ID一致
* 应答包的源IP地址与请求包的目的IP地址一致
* 应答包的目的IP地址和端口与请求包的源IP地址和端口一致
* 第一个到达的符合以上四个条件的应答包

### DNS漏洞

* 序列号攻击
* 攻击者可在应答中随意添加信息
* dns缓存

### DNS欺骗流 程

监听Client和Server之间的通信，虚假应答包在服务器正确的应答包到达前到达

### DNS下毒流程

监听DNS服务器之间的通信，虚假应答包在服务器正确的应答包到达前到达，TTL值设成较长时间

## 网络安全扫描

原理：向目标主机的TCP/IP服务端口发送探测数据包，记录目标主机的响应，分析响应判断服务端口是开是关，即可得知端口提供的服务和信息

### TCP connect()扫描

* 优点
  * 扫描迅速
  * 准确而且不需要任何权限，系统中的任何用户可以使用这个调用
  * 可以同时打开多个套接字，加速扫描，使用非阻塞I/O还允许设置一个低的时间用尽周期，同时观察多个套接字
* 缺点
  * 扫描方式不隐蔽，服务器日志会记录下大量密集的连接和错误记录
  * 易被目标主机防火墙发觉而被过滤掉

### TCP SYN扫描

* 优点
  * 扫描迅速快，效率高
  * 一般不会在目标计算机上留下记录，比较隐蔽
* 缺点
  * 大部分操作系统下，扫描主机需要构造适合于这种扫描的包，而通常情况下，必须要有root权限才能建立自己的SYN数据包

## 防火墙

### 访问控制

* 主体：指提出访问资源具体请求
* 客体：指被访问资源的实体
* 控制策略：主体对客体的相关访问规则集合，即属性集合

### 访问控制策略

* 最小特权原则：按照主体所需权利的最小化原则分配给主体权力
* 最小泄露原则：按照主体所需要知道的信息最小化的原则分配给主体权力
* 多级安全策略：绝密（TS）、秘密（S）、机密（C）、限制（RS）和无级别（U），高级别能访问低级别

### 自主访问控制模型DAC

概念：根据自主访问控制策略建立的一种模型，允许合法用户以用户或用户组的身份访问策略规定的客体，同时阻止非授权用户访问客体，某些用户还可以自主地把自己所拥有的客体的访问权限授予其它用户

### 强制访问控制模型MAC

概念：系统对访问主体和受控对象实行强制访问控制，事先分配不同的安全级别属性，比较属性决定是否能访问对象

* Lattice：事先安全分级
* Bell-LaPadula：应用于军事系统
  * 无上读、无下写
  * 出发点是维护系统的保密性，有效地防止信息泄露，忽略了完整性指标，使非法、越权篡改成为可能
* Biba：
  * 禁止向上写、没有向下读

### 防火墙定义

定义：位于两个或多个网络间实施网间访问控制的强制的一组组件的集合

条件：

* 所有进出被保护网络的通信必须通过防火墙
* 所有通过防火墙的通信必须经过安全策略的过滤或者防火墙的授权
* 防火墙自身应对渗透免疫

功能：

* 内容过滤
* 用户认证
* VPN
* 日志
* NAT
* IDS与报警
* 应用程序代理
* 访问控制

### 防火墙访问控制方法

* 服务控制：确定可以访问的服务类型
* 方向控制：确定特定的服务请求可以发起并允许通过防火墙
* 用户控制：不同的用户具有不同服务访问的权限
* 行为控制：控制怎样使用特定服务。如过滤垃圾邮件

### 防火墙分类

形态：

* 软件
* 硬件

技术：

* 包过滤
  * 包过滤防火墙对所接收的每个数据包做允许、拒绝的决定
  * 防火墙审查每个数据报以便确定其是否与某一条包过滤规则匹配
  * 过滤规则基于可以提供给IP转发过程的包头信息
  * 为静态包过滤与动态包过滤两类
* 应用网关
  * 对用户身份进行验证
  * 合法用户把请求转发给真正的内部网络的主机，监控用户行为，拒绝不合法的访问
  * 内部网络向外部网络申请服务时，代理服务器工作过程相反
* 代理
* 状态监测
  * 增加了状态检测机制
  * 具有跟踪的能力
* 电路级网关

部署位置：

* 主机
* 网络

### 网络地址翻译

目的：

* 解决ip地址空间不足
* 向外界隐藏内部网络结构

方式：

* M-1多个内部网址翻译到1个ip地址
* 1-1简单地址翻译
* M-N多个内部网址翻译到N个ip地址

类型：

* 静态NAT：内部网络每个主机都永久映射成外部合法的地址
* NAT池：外部网络中定义了一系列合法地址，动态分配方式映射到内部网络
* 端口NAT：内部网络地址映射到外部网络的一个ip地址的不同端口上

### 双重宿主主机体系

* 双重宿主主机体系结构是围绕双重宿主主机构筑的
* 双重宿主主机至少有两个网络接口
  * 它位于内部网络和外部网络之间，这样的主机可以充当与这些接口相连的网络之间的路由器，它能从一个网络接收IP数据包并将之发往另一网络
  * 双重宿主主机的防火墙体系结构禁止这种发送功能，完全阻止了内外网络之间的IP通信
* 两个网络之间的通信可通过应用层数据共享和应用层代理服务的方法实现。一般情况下采用代理服务的方法
* 双重宿主主机的特性
  * 安全，用户口令控制
  * 性能，支持许多用户访问
* 缺点：隔开内外网络的唯一屏障

### 屏蔽主机体系

* 防火墙和内部网络的堡垒主机承担安全责任。防火墙较简单，可能就是简单的路由器
* 典型构成：
  * 包过滤路由器+堡垒主机
    * 包过滤路由器配置在内部网和外部网之间，保证外部系统对内部网络的操作只能经过堡垒主机
    * 堡垒主机配置在内部网络上，是外部网络主机连接到内部网络主机的桥梁，它需要拥有高等级的安全
* 规则配置
  * 允许内部主机为了某些服务请求与外部网上的主机建立直接连接（经过过滤的服务）
  * 不允许所有来自外部主机的直接连接
* 安全性更高，双重保护：实现了网络层和应用层安全
* 缺点：过滤路由器能否正确配置是关键，路由器被损害，堡垒主机被穿过，整个网络对侵袭者开放

### 屏蔽子网体系

* 屏蔽子网体系结构在本质上与屏蔽主机体系结构一样，但添加了额外的一层保护体系——周边网络。堡垒主机位于周边网络上，周边网络和内部网络被内部路由器分开
* 堡垒主机是用户网络上最容易受侵袭的机器。通过在周边网络上隔离堡垒主机，能减少在堡垒主机被侵入的影响
* 周边网络是一个防护层，在其上可放置一些信息服务器，它们是牺牲主机，可能会受到攻击，因此又被称为非军事区（DMZ）
* 周边网络的作用：即使堡垒主机被入侵者控制，它仍可消除对内部网的侦听。例: netxray等的工作原理
* 堡垒主机
  * 堡垒主机位于周边网络，是整个防御体系的核心
  * 堡垒主机可被认为是应用层网关，可以运行各种代理服务程序
  * 对于出站服务不一定要求所有的服务经过堡垒主机代理，但对于入站服务应要求所有服务都通过堡垒主机
* 外部路由器（访问路由器）
  * 作用：保护周边网络和内部网络不受外部网络的侵犯
    * 它把入站的数据包路由到堡垒主机
    * 防止部分IP欺骗，它可分辨出数据包是否真正来自周边网络，而内部路由器不可
* 内部路由器（阻塞路由器）
  * 作用：保护内部网络不受外部网络和周边网络的侵害，它执行大部分过滤工作
  * 外部路由器一般与内部路由器应用相同的规则
* 优点：
  * 入侵者需突破3个不同的设备才能入侵内部网络
  * 只对外通告DMZ区的网络，保证内部网络不可见
  * 内部网络用户通过堡垒主机或代理服务器访问外部网络

## IDS

### 入侵检测的分类

入侵检测：搜集关键信息并进行分析，从中发现网络或系统中是否有违反安全策略的行为和遭到袭击的迹象的一种机制

* 根据数据的来源
  * 基于主机的入侵检测系统：监控力度更细、配置灵活、可用于加密的以及交换的环境
  * 基于网络的入侵检测系统：视野更宽、隐蔽性好、攻击者不易转移证据
* 根据检测原理
  * 异常入侵检测：根据异常行为和使用计算机资源的情况检测出来的入侵
  * 误用入侵检测：利用已知系统和应用软件的弱点攻击模式来检测入侵
* 根据体系结构
  * 集中式：多个分布于不同主机上的审计程序，一个入侵检测服务器
  * 等级式：定义了若干个分等级的监控区域，每个IDS负责一个区域，将分析结果传送给上一级IDS
  * 协作式：将中央检测服务器的任务分配给多个基于主机的IDS，IDS不分等级，各司其职
* 根据工作方式
  * 离线检测：非实时工作系统，事件发生后分析审计事件，从中检测入侵事件
  * 在线检测：对网络数据包或主机的审计事件进行实时分析，可快速反应，难以保证大规模系统的实时性

### HIDS

目标：主机系统和系统本地用户

原理：根据主机审计的数据和系统日志发现可疑事件

优点：

* 性能价格比高
* 细腻性，审计内容全面
* 视野集中
* 适用于加密及交换环境

缺点：

* IDS的运行影响服务器的性能
* HIDS依赖性强，依赖于审计数据或系统日志准确性和完整性，以及安全事件的定义
* 如果主机数目多，代价过大
* 不能监控网络上的情况

### NIDS

目标：网络

原理：根据网络流量、协议分析、单台或多台主机的审计数据检测入侵

优点：

* 服务器平台独立性：监视通信流量而不影响服务器的平台的变化和更新
* 配置简单：只需要一个普通的网络访问接口即可
* 众多的攻击标识：探测器可以监视多种多样的攻击包括协议攻击和特定环境的攻击

缺点：

* 不能检测不同网段的网络包
* 很难检测复杂的需要大量计算的攻击
* 协同工作能力弱
* 难以处理加密的会话

### 入侵检测结构CIDF

* 事件产生器
  * 事件产生器的目的是从整个计算环境中获得事件，并向系统的其他部分提供此事件
  * 入侵检测的第一步
  * 采集内容包括系统日志、应用程序日志、系统调用、网络数据、用户行为、其他IDS的信息
* 事件分析器
  * 事件分析器分析得到的数据，并产生分析结果
  * 分析是核心，效率高低直接决定整个IDS性能
* 响应单元
  * 响应单元则是对分析结果作出作出反应的功能单元
    * 告警和事件报告
    * 终止进程，强制用户退出
    * 切断网络连接，修改防火墙设置
    * 灾难评估，自动恢复
    * 查找定位攻击者
* 事件数据库
  * 事件数据库是存放各种中间和最终数据的地方的统称，它可以是复杂的数据库，也可以是简单的文本文件

### 异常检测技术

* 思想：任何正常人的行为有一定规律，而入侵会引起用户或系统行为的异常
* 需要考虑的问题：
  * 选择哪些数据表现用户的行为
  * 通过以上数据如何有效的表示用户的行为，主要在于学习和检测方法的不同
  * 考虑学习过程的长度、用户行为的时效性等
* 典型的算法：统计分析（均值、偏差、Markov过程）
* 异常检测模型
  * 总结正常操作应该具有的特征，用户活动与正常行为有重大偏离时被认为是入侵
* 检测原理
  * 正常行为的特征轮廓
  * 检查系统的运行情况
  * 是否偏离预设的门限
* 优点:
  * 可以检测到未知的入侵
  * 可以检测冒用他人帐号的行为
  * 具有自适应，自学习功能
  * 不需要系统先验知识
* 缺点：
  * 漏报、误报率高：入侵者可以逐渐改变自己的行为模式来逃避检测；合法用户正常行为的突然改变也会造成误警
  * 统计算法的计算量庞大，效率很低
  * 统计点的选取和参考库的建立比较困难
* 统计分析
  * 依据系统中特征变量的历史数据建立统计模型，并运用该模型对特征变量未来的取值进行预测和检测偏离
  * 典型的系统主体特征有：
    * 系统中的特征变量有用户登录失败次数
    * CPU和I/O利用率
    * 文件访问数及访问出错率
    * 网络连接数
    * 击键频率
    * 事件间的时间间隔等
  * 缺点：
    * 未考虑事件的发生顺序，所以对利用事件顺序关系的攻击难以检测
    * 利用统计轮廓的动态自适应性，通过缓慢改变其行为来训练正常特征轮廓，最终使检测系统将其异常活动判为正常
    * 难以确定门限值
    * 模型分类
      * 均值与标准偏差模型
      * 多元模型
      * Markov过程模型
      *  时间序列模型

### 误用检测技术

* 思想：主要是通过某种方式预先定义入侵行为，然后监视系统，从中找出符合预先定义规则的入侵行为
* 误用信号需要对入侵的**特征**、**环境**、**次序**以及**完成入侵的事件**相互间的关系进行描述
* 重要问题
  * 如何全面的描述攻击的特征
  * 如何排除干扰，减小误报
  * 解决问题的方式
* 典型算法：专家系统、模型推理、完整性分析
* 优点：
  * 算法简单
  * 系统开销小
  * 准确率高
  * 效率高
* 缺点：
  * 被动：只能检测出已知攻击、新类型的攻击会对系统造成很大的威胁
  * 模式库的建立和维护难：模式库需要不断维护更新，只是依赖于硬件平台、操作系统和系统中运行的应用
* 模型推理
  * 指结合攻击脚本推理出入侵行为是否出现
  * 其中有关攻击者行为的知识被描述为：攻击者目的，攻击者达到此目的的可能行为步骤，以及对系统的特殊使用等
  * 根据这些知识建立攻击脚本库，每一脚本都由一系列攻击行为组成
  * 减少了需要处理的数据量，如何有效地翻译攻击脚本是问题

### SNORT

* 典型的误用检测技术
* 需要准确理解攻击模式并撰写检测规则
* 无法应对未知攻击，造成漏报
* 检测效率高、准确率高
* 攻击规则更新要求高，好在攻击方式变化不剧烈

## VPN

* 定义：是指依靠ISP或其他NSP在公用网络基础设施之上构建的专用的数据通信网络，这里所指的公用网络有多种，包括IP网络、帧中继网络和 ATM网络

* 虚拟
* 专用网：封闭的用户群、安全性高、服务质量保证
* 实现要求：支持数据分组的透明传输、支持安全功能、提供服务质量保证
* 功能：
  * 数据机密性保护
  * 数据完整性保护
  * 数据源身份认证
  * 重放攻击保护
* 应用类型：
  * client - lan
  * lan - lan
* 划分：
  * 业务类型划分
    - 内部公文流转 Intranet VPN
    - 远程拨号 Access VPN
    - 各分支机构互联 Extranet VPN
  * 发起主体划分
    - 客户发起
    - 服务器发起

### 隧道技术

* 隧道是在公共通信网络上构建的一条数据路径，可以提供与专用通信线路等同的连接特性
* 隧道使用隧道协议来封装数据。一种协议X的数据报被封装在协议Y中，可以实现协议X在公共网络的透明传输。这里协议X称作被封装协议，协议Y称为封装协议。隧道的一般封装格式为(协议Y(隧道头(协议X)))
* 隧道协议
  * 第二层隧道
    * PPTP
      * 点对点通道协议，提供客户机和服务器间的加密通信
    * L2F：透过任何拨号方式接入公共IP 网络
      * 首先按常规方式拨号到ISP 的接入服务器（NAS），建立PPP连接
      * NAS 根据用户名等信息， 发起第二重连接， 通向HGW （家庭网关）服务器
      * 在这种情况下隧道的配置和建立对用户是完全透明的
    * L2TP
      * 让用户从客户端或访问服务器端发起VPN 连接。L2TP 是把链路层PPP 帧封装在公共网络设施和IP、ATM、帧中继中进行隧道传输的封装协议
  * 第三层隧道
    * IPSec
* 隧道的定义：实质上是一种封装，将一种协议（协议X）封装在另一种协议（协议Y）中传输，从而实现协议X对公用传输网络(采用协议Y)的透明性
* 隧道协议内包括以下三种协议
  * 乘客协议（Passenger Protocol）
  * 封装协议（Encapsulating Protocol）
  * 运载协议（Carrier Protocol）

| IP头     | PPTP头   | PPP      |
| -------- | -------- | -------- |
| 运载协议 | 封装协议 | 乘客协议 |

### IPSec

* 能解决的问题
  * 数据源身份认证：证实数据报文是所声称的发送者发出的
  * 数据完整性：证实数据报文的内容在传输过程中没被修改过，无论是被故意改动或是由于发生了随机的传输错误
  * 数据保密：隐藏明文的消息，通常靠加密来实现
  * 重放攻击保护：保证攻击者不能截获数据报文，且稍后某个时间再发放数据报文，而不会被检测到
  * 自动的密钥管理和安全关联管理：保证只需少量或根本不需要手工配置，就可以在扩展的网络上方便精确地实现公司的虚拟使用网络方针
* 认证头部（AH）
  * 认证数据：ICV，变长字段，长度=整数倍32位bit
  * 序列号：32bit，单项底层的计数器，用于重放攻击，初始化为0，不许重复
  * SPI：32bit，标识相同IP和相同协议的不同sa
  * 下一头部：8bit，标志认证头的下一个负载类型
  * 保留字段：16bit，default=0
  * 负载长度：8bit，default=4，AH长度减2
* 负载安全封装（ESP）
  * 认证数据：ICV，变长字段，长度=整数倍32位bit
  * 序列号：32bit，单项底层的计数器，用于重放攻击，初始化为0，不许重复
  * SPI：32bit，标识相同IP和相同协议的不同sa
  * 下一头部：8bit，标志认证头的下一个负载类型
  * 保留字段：16bit，default=0
  * 负载长度：变长长度
  * 填充长度：8bit，标识认证头后面的下一个负载类型
* 传输模式

![ipsec传输模式](/image/ipsec传输模式.png)

* 隧道模式

![ipsec隧道模式](/image/ipsec隧道模式.png)

### SADB

* SA：两个IPSec通信实体之间经协商建立起来的一种共同协定，它规定了通信双方使用哪种IPSec协议保护数据安全、应用的算法标识、加密和验证的密钥取值以及密钥的生存周期等等安全属性值
* 安全联盟常用参数
  * 加密及验证密钥
  * 密码算法在系统中的标识
  * 序列号，32位的字段，在处理外出的数据包时，一个SA被应用一次，它的序列号号字段就
    递增一，并被填充到数据包的IPSec头中，接收方可以利用此字段进行抗重播攻击
  * 抗重播窗口。接收方使用滑动窗口算法来进行对恶意主机重复发出的数据包进行检测
  *  生存周期。规定了该SA的有效使用周期，可以按照建立至今的时间或者处理的流量来计算
  *  实施模式。即通道模式还是传输模式
  *  IPSec隧道目的地址
  * 安全参数索引(SPI)。参与唯一标识某SA

### IPSec流程

* 输出处理
  * SP决定丢弃此包，于是直接丢弃，或者还可以向源主机发送ICMP信息
  * SP决定通过此包，直接将数据包投放到网络设备的发送队列
  * SP决定应用IPSec，此时SP要么指向一个SA,可以根据它进行安全处理，要么需要的SA不存在，则触发IKE模块协商建立SA，协商周期内数据包进入等待队列等待协商完成，若协商超时，也会丢弃该包
* 输入处理
  * 系统收到IP包后，判断如果是IPSec包，则从头部取到<dst_ip,protocol,SPI>，搜索SADB
    * 若找不到SA，丢弃包
    * 若找到，根据其进行解封装，得到去通道化后的原始IP包，再从原始IP包中提取选择符，搜索到SPD中某一条目，检查收到包的安全处理是否符合描述规则，不符合则丢弃包，符合则转入系统IP协议栈进行后继处理

### IKE

用途：在IPSec通信双方之间通过协商建立起共享安全参数及验证过的密钥，也就是建立安全联盟

* 阶段一交换：在“阶段一”周期里，两个IKE实体建立一个安全的，经验证的信道进行后续通信，要建立这样的安全信道，双方会建立一对ISAKMP安全联盟。阶段一交换可以用 **身份保护模式(也叫主模式)或野蛮模式 或野蛮模式**来实现，而这两种模式也仅用于阶段一中

![IKE阶段一](/image/IKE阶段一.png)

* 阶段二交换：“阶段二”周期里，IKE实体会在阶段一建立起来的安全信道中，为某种进程协商和产生需要的密钥材料和安全参数，在VPN实现中，就是**建立IPSec安全联盟**。快速模式交换可用来实现阶段二交换并且仅用于此阶段中

### SSL

* ssl协议体系
  * 底层：ssl记录协议
  * 上层：ssl握手协议、ssl密码变化协议、ssl警告协议
* ssl链接
  * 提供合适类型服务的传输
  * 点对点
  * 链接暂时，一个连接一个会话
* ssl会话
  * ssl会话是客户端和服务器的一个关联，由Handshake Protocol创建，会话定义加密安全参数
  * 避免为每一个链接提供新的参数所需昂贵的谈判代价
* ssl记录层协议
  1. fragmentation：上层消息的数据被分片成214字节大小的块，或者更小
  2. compression：必须是无损压缩，如果数据增加的话，则增加部分的长度不超过1024字节
  3. 计算消息认证码(MAC)
  4. encryption
     * 采用CBC，算法由cipher spec指定
     * 数据长度不超过2 14 +2048字节
* ssl密钥交换
  * 功能
    * 客户和服务器之间相互认证
    * 协商加密算法和密钥
    * 它提供连接安全性，有三个特点
      * 身份认证，至少对一方实现认证，也可以是双向认证
      * 协商得到的共享密钥是安全的，中间人不能够知道
      * 协商过程是可靠的
  * 规范说明
    * 位于TLS记录协议之上，也用到了TLS记录协议的处理过程
    * ContentType = 22
  * 流程
    1. 交换Hello消息，对于算法、交换随机值等协商一致
    2. 交换必要的密码参数，以便双方得到统一的premaster secret
    3. 交换证书和相应的密码信息，以便进行身份认证
    4. 产生master secret
    5. 把安全参数提供给TLS记录层
    6. 检验双方是否已经获得同样的安全参数

## PGP

### 操作描述

*  发送者创建报文
  * 使用SHA-1生成报文的160位散列码
  *  使用发送者的私有密钥，用RSA算法对散列码加密(签名)，并置在报文前面
  *  接收者使用发送者的公开密钥，用RSA解密和恢复散列码
  * 接收者计算报文的散列码，与解密得到的进行比较，如果两者匹配，则报文通过鉴别

### 身份认证

* 发送方
  * 产生消息M
  * 用SHA-1对M生成一个160位散列码
  * 发送者对H加密，与M链接
* 接收方
  * 用公钥解密并恢复散列码H
  * 对M生成一个新的散列码，与H比较，如果一致则认证

![身份认证](/image/身份认证.png)



### 保密性

* 发送方
  * 生成消息M并为该消息生成一个随机数作为会话密钥
  * 用会话密钥加密M
  * 用接收者的公钥加密会话密钥并与消息M结合
* 接收方
  * 用自己的私钥解密恢复会话密钥
  * 用会话密钥解密恢复消息M

![保密性](/image/保密性.png)

### 保密与认证的结合

发送者先用自己的私钥签名，然后用会话密钥加密消息，再用接收者的公钥加密会话密钥

![保密与认证的结合](/image/保密与认证的结合.png)

### 加密密钥和密钥环

* 四种类型密钥
  * 一次性会话传统密钥
  * 公钥
  * 私钥
  * 基于口令短语的传统密钥
* PGP对密钥的需求
  * 会话密钥：需要一种生成不可预知的会话密钥的方法，PGP使用了一种复杂的随机密钥生成算法(一定的真随机性)
  * 公钥和私钥
    * 需要某种手段来标识具体的密钥
    * 一个用户拥有多个公钥/私钥对
    * 密钥更新管理

### 密钥标识符和密钥环

* 一个用户有多个公钥/私钥对时，接收者如何知道发送者是用哪个公钥来加密会话密钥的
  * 将公钥与消息一起传送
  * 将一个标识符与一个公钥关联，对一个用户来说唯一。即用户ID和密钥ID标识一个密钥
* 定义KeyID 包括64个有效位(PGP采用公钥的低64位作为KeyID)
* 对于PGP数字签名，KeyID也很必需。用哪个公钥来验证签名
  * 钥匙环
    * PGP消息中包括两个keyID，分别提供保密与认证功能
    * 需要一种系统化的方法存储和组织这些密钥以保证有效使用这些密钥
* PGP密钥管理方案
  * 用户机器(节点)上有一对数据结构
    * 私钥环：存储本节点拥有的公钥/私钥对
    * 公钥环：存储本节点所知道的其他用户的公钥

### PGP私钥环

* 信息：时间戳、KeyID、公钥、私钥、UserID
* UserID：通常是用户的邮件地址。也可以是一个名字，可以重名
* 私钥如何保存：
  * 用户选择一个口令短语用于加密私钥
  * 当系统用RSA生成一个新的公钥/私钥对时，要求用户输入口令短语。对该短语使用SHA-1生成一个160位的散列码后，销毁该短语
  * 系统用其中128位作为密钥用CAST-128加密私钥，然后销毁这个散列码，并将加密后的私钥存储到私钥环中
  * 当用户要访问私钥环中的私钥时，必须提供口令短语。PGP将取出加密后的私钥，生成散列码，解密私钥

### 邮件数据处理

* 顺序：签名 —— 压缩 —— 加密
* 压缩对邮件传输或存储都有节省空间的好处
* 签名后压缩的原因
  * 不需要为检验签名而保留压缩版本的消息
  * 为了检验而再做压缩不能保证一致性，压缩算法的不同实现版本可能会产生不同的结果
* 压缩之后再做加密的原因
  * 压缩后的消息其冗余小，增加密码分析的难度
  * 若先加密，则压缩难以见效
* E-mail兼容性
  * PGP处理后的消息，部分或者全部是加密后的消息流，为任意的8位字节。某些邮件系统只允许ASC字符，所以PGP提供了转换到ASC格式的功能。采用了Radix-64转换方案
